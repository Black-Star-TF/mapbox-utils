<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>GeoJSONLayer</title>

		<script src="./lib/dat.gui/dat.gui.js"></script>
		<link rel="stylesheet" href="./lib/dat.gui/dat.gui.css" />

		<script src="./lib/mapbox-gl/mapbox-gl.js"></script>
		<link rel="stylesheet" href="./lib/mapbox-gl/mapbox-gl.css" />

		<script src="./lib/turf/turf.js"></script>
		<script src="../dist/mapbox-utils.min.js"></script>
		<link rel="stylesheet" href="../dist/mapbox-utils.css" />

		<script src="./common/mapbox-style.js"></script>
		<style>
			* {
				margin: 0;
				padding: 0;
			}
			body {
				width: 100vw;
				height: 100vh;
			}
			#map-container {
				width: 100%;
				height: 100%;
			}
		</style>
	</head>
	<body>
		<div id="map-container"></div>
		<script>
			const gui = new dat.GUI()
			const option = {
				mapStyle: 'Electronic',
				addTo() {
					geojsonLayer.addTo(map)
				},
				remove() {
					geojsonLayer.remove()
				},
				setData() {
					geojsonLayer.setData(getData())
				}
			}
			gui
				.add(option, 'mapStyle')
				.options(['Electronic', 'Satellite'])
				.onChange((val) => {
					map.setStyle(mapStyles[option.mapStyle], {
						diff: false
					})
				})
				.name('style')
			gui.add(option, 'addTo')
			gui.add(option, 'remove')
			gui.add(option, 'setData')

			const map = new mapboxgl.Map({
				container: 'map-container',
				zoom: 10,
				minZoom: 1,
				maxZoom: 18,
				center: [106.263683, 29.274074],
				style: mapStyles[option.mapStyle]
			})

			map.on('mousedown', (e) => {
				console.log('mousedown')
			})
			map.on('mouseup', (e) => {
				console.log('mouseup')
			})

			map.on('drag', (e) => {
				console.log('dblclick')
			})
			map.on('dragstart', (e) => {
				console.log('dragstart')
			})
			map.on('dragend', (e) => {
				console.log('dragend')
			})

			const geojsonLayer = new MapboxUtils.GeoJSONLayer({
				layerPool: {
					point: {
						type: 'circle',
						paint: {
							'circle-color': '#0f0',
							'circle-radius': 10,
							'circle-opacity': 0.5
						},
						filter: ['==', ['geometry-type'], 'Point']
					},
					line: {
						type: 'line',
						paint: {
							'line-color': '#699',
							'line-width': 3
						},
						filter: ['==', ['geometry-type'], 'LineString']
					},
					border: {
						type: 'line',
						paint: {
							'line-color': '#f08',
							'line-width': 2
						},
						filter: ['==', ['geometry-type'], 'Polygon']
					},
					fill: {
						type: 'fill',
						paint: {
							'fill-color': '#f08',
							'fill-opacity': 0.2
						},
						filter: ['==', ['geometry-type'], 'Polygon']
					}
				},
				layers: ['fill', 'border', 'line', 'point'],
				fitBoundsOptions: true,
				lineMetrics: true
			})
			geojsonLayer.addTo(map)
			geojsonLayer.setData(getData())
			geojsonLayer.on('contextmenu', (e) => {
				console.log(e)
			})

			geojsonLayer.on('click', (e) => {
				console.log(e)
			})

			function getData() {
				return turf.featureCollection([
					...turf.randomPoint(100, { bbox: [105, 29, 106, 30] }).features,
					...turf.randomPolygon(20, {
						bbox: [105, 29, 106, 30],
						max_radial_length: 0.5,
						num_vertices: 4
					}).features,
					...turf.randomLineString(20, { bbox: [105, 29, 106, 30], max_length: 0.3 }).features
				])
			}
		</script>
	</body>
</html>
